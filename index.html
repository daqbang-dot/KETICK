// ==========================================
// 1. DATA STORAGE & INITIALIZATION
// ==========================================
let crmData = JSON.parse(localStorage.getItem('crm')) || [];
let inventoryData = JSON.parse(localStorage.getItem('inventory')) || [];
let clientData = JSON.parse(localStorage.getItem('clients')) || [];
let historyData = JSON.parse(localStorage.getItem('history')) || [];
let currentBillItems = [];
let currentBillType = "INVOICE";

// ==========================================
// 2. NAVIGATION & UI CONTROL
// ==========================================
function showSection(id) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    renderAll();<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Bisnes - MyBiz</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <nav class="no-print">
        <h2>MyBiz Admin</h2>
        <ul>
            <li><a href="#" onclick="showSection('dashboard')">Dashboard</a></li>
            <li><a href="#" onclick="showSection('crm')">CRM</a></li>
            <li><a href="#" onclick="showSection('inventory')">Inventory</a></li>
            <li><a href="#" onclick="showSection('clients')">Clients</a></li>
            <li><a href="#" onclick="showSection('billing')">Billing</a></li>
            <li><a href="#" onclick="showSection('history')">History</a></li>
        </ul>
    </nav>

    <div class="container">
        
        <section id="dashboard" class="active">
            <h1>Business Dashboard</h1>
            <div style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px; background: #2980b9; color: white; padding: 20px; border-radius: 8px;">
                    <h3>Total Jualan (RM)</h3>
                    <h2 id="dash-total-sales">0.00</h2>
                </div>
                <div style="flex: 1; min-width: 200px; background: #27ae60; color: white; padding: 20px; border-radius: 8px;">
                    <h3>Resit Dikeluarkan</h3>
                    <h2 id="dash-total-rec">0</h2>
                </div>
                <div style="flex: 1; min-width: 200px; background: #f39c12; color: white; padding: 20px; border-radius: 8px;">
                    <h3>Quotation Aktif</h3>
                    <h2 id="dash-total-quo">0</h2>
                </div>
            </div>
        </section>
        
        <section id="crm">
            <h1>Customer Relationship Management (CRM)</h1>
            <form id="crm-form">
                <input type="text" id="lead-name" placeholder="Nama Prospek" required>
                <select id="lead-status">
                    <option value="New">Baru</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Closed">Selesai</option>
                </select>
                <button type="submit">Tambah Lead</button>
            </form>
            <table>
                <thead>
                    <tr><th>Nama</th><th>Status</th><th>Tindakan</th></tr>
                </thead>
                <tbody id="crm-list"></tbody>
            </table>
        </section>

        <section id="inventory">
    <h1>Inventory Database</h1>
    <form id="inv-form">
        <input type="text" id="item-name" placeholder="Nama Barang" required>
        <input type="text" id="item-desc" placeholder="Penerangan/Description (Opsional)">
        <input type="number" id="item-qty" placeholder="Kuantiti" required>
        <input type="number" id="item-price" placeholder="Harga (RM)" step="0.01" required>
        <button type="submit">Tambah Stok</button>
    </form>
    <table>
        <thead>
            <tr>
                <th>Barang</th>
                <th>Description</th> <th>Kuantiti</th>
                <th>Harga</th>
                <th>Tindakan</th>
            </tr>
        </thead>
        <tbody id="inv-list"></tbody>
    </table>
</section>

        <section id="clients">
            <h1>Client Database</h1>
            <form id="client-form">
                <input type="text" id="client-name" placeholder="Nama Pelanggan" required>
                <input type="email" id="client-email" placeholder="Email">
                <input type="text" id="client-phone" placeholder="No. Telefon">
                <button type="submit">Simpan Pelanggan</button>
            </form>
            <table>
                <thead>
                    <tr><th>Nama</th><th>Email</th><th>Telefon</th><th>Tindakan</th></tr>
                </thead>
                <tbody id="client-list"></tbody>
            </table>
        </section>

        <section id="billing">
            <h1 class="no-print">Billing & Documentation</h1>
            
            <div class="billing-controls no-print">
                <div style="margin-bottom: 15px;">
                    <label>1. Pilih Pelanggan:</label>
                    <select id="bill-client-select" style="width: 100%; margin-top:5px;"></select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>2. Pilih Produk/Servis:</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <select id="bill-item-select" style="flex-grow:1;"></select>
                        <button onclick="addToBill()" style="background:#3498db;">+ Tambah</button>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="generateDocument('QUOTATION')" style="background:#f39c12; flex:1; min-width: 150px;">Cetak Quotation</button>
                    <button onclick="generateDocument('INVOICE')" style="background:#2980b9; flex:1; min-width: 150px;">Cetak Invoice</button>
                    <button onclick="generateDocument('RECEIPT')" style="background:#27ae60; flex:1; min-width: 150px;">Cetak Receipt</button>
                </div>
            </div>

            <div id="billing-print-area">
                <div style="display:flex; justify-content:space-between; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">
                    <div>
                        <h2 id="bill-type" style="margin:0; color:#2c3e50;">INVOICE</h2>
                        <p style="font-size:0.8rem; color:#7f8c8d;">Ref: <span id="bill-ref-no">-</span></p>
                    </div>
                    <div style="text-align:right;">
                        <h4 style="margin:0;">NAMA SYARIKAT ANDA</h4>
                        <p style="font-size:0.8rem;">Alamat Perniagaan Anda, Malaysia</p>
                    </div>
                </div>

                <div class="bill-info" style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <div>
                        <p><strong>Kepada:</strong></p>
                        <div id="bill-client-display">Sila pilih pelanggan...</div>
                    </div>
                    <div style="text-align:right;">
                        <p><strong>Tarikh:</strong> <span id="bill-date">-</span></p>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Deskripsi Item</th>
                            <th>Harga (RM)</th>
                            <th class="no-print">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="bill-items-list"></tbody>
                    <tfoot>
                        <tr>
                            <th style="text-align:right;">JUMLAH KESELURUHAN:</th>
                            <th colspan="2">RM <span id="bill-total">0.00</span></th>
                        </tr>
                    </tfoot>
                </table>

                <div style="margin-top:50px; font-size: 0.8rem; border-top: 1px solid #eee; padding-top:10px;">
                    <p>* Ini adalah dokumen janaan komputer. Tandatangan tidak diperlukan.</p>
                </div>
            </div>
        </section>

        <section id="history">
            <h1>Sales & Document History</h1>
            <div style="margin-bottom: 20px;">
                <button onclick="clearHistory()" style="background:#e74c3c;">Kosongkan Semua Sejarah</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Tarikh</th>
                        <th>Jenis</th>
                        <th>No. Dokumen</th>
                        <th>Pelanggan</th>
                        <th>Jumlah (RM)</th>
                        <th>Tindakan</th>
                    </tr>
                </thead>
                <tbody id="history-list"></tbody>
            </table>
        </section>

    </div> 

    <script src="app.js"></script>
</body>
</html>
}

// ==========================================
// 3. CORE LOGIC (CRM & CLIENTS)
// ==========================================

// CRM Logic
document.getElementById('crm-form').addEventListener('submit', (e) => {
    e.preventDefault();
    crmData.push({ 
        id: Date.now(), 
        name: document.getElementById('lead-name').value, 
        status: document.getElementById('lead-status').value 
    });
    saveAndRender();
    e.target.reset();
});

// Client Logic
document.getElementById('client-form').addEventListener('submit', (e) => {
    e.preventDefault();
    clientData.push({ 
        id: Date.now(), 
        name: document.getElementById('client-name').value, 
        email: document.getElementById('client-email').value, 
        phone: document.getElementById('client-phone').value 
    });
    saveAndRender();
    e.target.reset();
});

// ==========================================
// 4. INVENTORY LOGIC (DENGAN DESCRIPTION)
// ==========================================
document.getElementById('inv-form').addEventListener('submit', (e) => {
    e.preventDefault();
    inventoryData.push({ 
        id: Date.now(), 
        item: document.getElementById('item-name').value, 
        desc: document.getElementById('item-desc').value, // Simpan description
        qty: document.getElementById('item-qty').value, 
        price: document.getElementById('item-price').value 
    });
    saveAndRender();
    e.target.reset();
});

// ==========================================
// 5. BILLING & DOCUMENT LOGIC
// ==========================================

function setBillType(type) {
    currentBillType = type;
    document.getElementById('bill-type').innerText = type;
    const billArea = document.getElementById('billing-print-area');
    if(type === 'QUOTATION') billArea.style.borderColor = "#f39c12";
    else if(type === 'RECEIPT') billArea.style.borderColor = "#27ae60";
    else billArea.style.borderColor = "#2980b9";
}

function addToBill() {
    const itemIndex = document.getElementById('bill-item-select').value;
    const selectedItem = inventoryData[itemIndex];
    if (selectedItem) {
        currentBillItems.push({
            item: selectedItem.item,
            desc: selectedItem.desc || "", // Masukkan desc ke dalam bill
            price: parseFloat(selectedItem.price)
        });
        renderBillingTable();
    } else {
        alert("Sila pilih item!");
    }
}

function renderBillingTable() {
    const list = document.getElementById('bill-items-list');
    let total = 0;
    list.innerHTML = currentBillItems.map((i, index) => {
        total += i.price;
        return `<tr>
            <td>
                <strong>${i.item}</strong><br>
                <small style="color:#666;">${i.desc}</small> 
            </td>
            <td>RM ${i.price.toFixed(2)}</td>
            <td class="no-print">
                <button onclick="removeFromBill(${index})" style="background:#e74c3c; padding:2px 5px; color:white; border:none; cursor:pointer; border-radius:3px;">X</button>
            </td>
        </tr>`;
    }).join('');
    document.getElementById('bill-total').innerText = total.toFixed(2);
}

function removeFromBill(index) {
    currentBillItems.splice(index, 1);
    renderBillingTable();
}

function generateDocument(type) {
    const clientIndex = document.getElementById('bill-client-select').value;
    if (clientIndex === "" || currentBillItems.length === 0) {
        alert("Sila pilih pelanggan dan tambah item!");
        return;
    }

    const client = clientData[clientIndex];
    const totalAmount = document.getElementById('bill-total').innerText;

    // Logik Nombor Rujukan
    const count = historyData.filter(h => h.type === type).length;
    const nextNo = 1001 + count;
    let prefix = type === 'QUOTATION' ? "QUO" : (type === 'RECEIPT' ? "REC" : "INV");
    const docNo = `${prefix}${nextNo}`;

    // Update UI
    setBillType(type);
    document.getElementById('bill-ref-no').innerText = docNo;
    document.getElementById('bill-date').innerText = new Date().toLocaleDateString('ms-MY');
    document.getElementById('bill-client-display').innerHTML = `<strong>${client.name}</strong><br>${client.email}<br>${client.phone}`;

    // Simpan ke History
    historyData.push({
        id: Date.now(),
        date: new Date().toLocaleDateString('ms-MY'),
        time: new Date().toLocaleTimeString('ms-MY'),
        type: type,
        docNo: docNo,
        clientName: client.name,
        amount: totalAmount,
        items: [...currentBillItems]
    });
    localStorage.setItem('history', JSON.stringify(historyData));

    setTimeout(() => {
        window.print();
        if(type === 'RECEIPT') {
            currentBillItems = [];
            renderBillingTable();
        }
        renderAll();
    }, 300);
}

// ==========================================
// 6. DASHBOARD & HISTORY
// ==========================================
function updateDashboard() {
    let totalSales = 0, recCount = 0, quoCount = 0;
    historyData.forEach(h => {
        if(h.type === 'RECEIPT' || h.type === 'INVOICE') totalSales += parseFloat(h.amount);
        if(h.type === 'RECEIPT') recCount++;
        if(h.type === 'QUOTATION') quoCount++;
    });
    if(document.getElementById('dash-total-sales')) {
        document.getElementById('dash-total-sales').innerText = totalSales.toFixed(2);
        document.getElementById('dash-total-rec').innerText = recCount;
        document.getElementById('dash-total-quo').innerText = quoCount;
    }
}

function renderHistory() {
    const list = document.getElementById('history-list');
    if(!list) return;
    list.innerHTML = [...historyData].reverse().map(h => `
        <tr>
            <td>${h.date}</td>
            <td><span class="badge ${h.type.toLowerCase()}">${h.type}</span></td>
            <td>${h.docNo}</td>
            <td>${h.clientName}</td>
            <td>RM ${h.amount}</td>
            <td>
                <button onclick="viewHistoryItem(${h.id})" style="background:#3498db; padding:5px; color:white; border:none; border-radius:3px; cursor:pointer;">Lihat</button>
                <button onclick="deleteHistoryItem(${h.id})" style="background:#e74c3c; padding:5px; color:white; border:none; border-radius:3px; cursor:pointer;">Hapus</button>
            </td>
        </tr>
    `).join('');
}

// ==========================================
// 7. RENDER ALL & SAVE
// ==========================================
function renderAll() {
    // Render CRM
    document.getElementById('crm-list').innerHTML = crmData.map(d => `<tr><td>${d.name}</td><td>${d.status}</td><td><button onclick="deleteItem('crm', ${d.id})">Padam</button></td></tr>`).join('');
    
    // Render Inventory (Dengan Description)
    const invList = document.getElementById('inv-list');
    if(invList) {
        invList.innerHTML = inventoryData.map(d => `
            <tr>
                <td>${d.item}</td>
                <td><small>${d.desc || '-'}</small></td>
                <td>${d.qty}</td>
                <td>RM ${parseFloat(d.price).toFixed(2)}</td>
                <td><button onclick="deleteItem('inventory', ${d.id})">Padam</button></td>
            </tr>`).join('');
    }

    // Render Clients
    document.getElementById('client-list').innerHTML = clientData.map(d => `<tr><td>${d.name}</td><td>${d.email}</td><td>${d.phone}</td><td><button onclick="deleteItem('clients', ${d.id})">Padam</button></td></tr>`).join('');

    // Update Dropdowns
    const clientSelect = document.getElementById('bill-client-select');
    if(clientSelect) {
        const currentVal = clientSelect.value;
        clientSelect.innerHTML = '<option value="">-- Pilih Pelanggan --</option>' + clientData.map((d, i) => `<option value="${i}">${d.name}</option>`).join('');
        clientSelect.value = currentVal;
    }

    const itemSelect = document.getElementById('bill-item-select');
    if(itemSelect) {
        itemSelect.innerHTML = '<option value="">-- Pilih Item --</option>' + 
            inventoryData.map((d, i) => `<option value="${i}">${d.item} ${d.desc ? '('+d.desc+')' : ''}</option>`).join('');
    }

    updateDashboard();
    renderHistory();
}

function deleteItem(type, id) {
    if (type === 'crm') crmData = crmData.filter(i => i.id !== id);
    else if (type === 'inventory') inventoryData = inventoryData.filter(i => i.id !== id);
    else if (type === 'clients') clientData = clientData.filter(i => i.id !== id);
    saveAndRender();
}

function deleteHistoryItem(id) {
    if(confirm("Padam rekod ini?")) {
        historyData = historyData.filter(h => h.id !== id);
        localStorage.setItem('history', JSON.stringify(historyData));
        renderAll();
    }
}

function saveAndRender() {
    localStorage.setItem('crm', JSON.stringify(crmData));
    localStorage.setItem('inventory', JSON.stringify(inventoryData));
    localStorage.setItem('clients', JSON.stringify(clientData));
    renderAll();
}

// Mula Sistem
renderAll();
